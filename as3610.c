/*
 * File:   as3610.c
 * Author: emu
 *
 * Created on 12. December 2013, 20:00
 */

#include "as3610.h"
#include <stdlib.h>
#include "errno.h"
#include <p24Fxxxx.h>
#include "i2c_driver.h"


static int as3610write(unsigned char reg, unsigned char val) {
    unsigned char buf[2];
    buf[0] = reg;
    buf[1] = val;

    if (i2cTx(0x8C, buf, 2) != 2)
        return 1;
    else
        return 0;
}

static int test4(unsigned char reg, unsigned char *val) {//*ist der inhalt - adresse ist bestimmter platz im arbeitspeicher *val zeigt auf buffer
    if (i2cRx(0x8D, &reg, 1, val, 1) != 1)
        return 1;
    else
        return 0;
}

unsigned char as3610read(unsigned char readbyte)
{
    unsigned char buffer;
    test4(readbyte,&buffer);//er gibt ihn die adresse wo buffer stehtund kann dann direkt in buffer reinschreiben
    return buffer;
}

void init_as3610_c1()
{
    //ist custom config.
    as3610write(AS3610_CHARGER_CONTROL_1_REGISTER,AS3610_NO_BAT_DET_EN|AS3610_DISABLE_TOFF|AS3610_PRECHG_EN|USB_CURRENT_VALUE_100_OR_500_MA|AS3610_BOOST_EN|AS3610_CHG_EN);
    as3610write(AS3610_CHARGER_VOLTAGE_CONTROL_REGISTER,AS3610_VCHG_MIN_LT_3_9_V|AS3610_VEOC_4_20_V);
    as3610write(AS3610_CHARGER_CURRENT_CONTROL_REGISTER,AS3610_DEB_TIMER_30_MSEC|AS3610_EN_PON|AS3610_BOOST_LOWCURR_200_MA|AS3610_CONSTCURR_1xICHARGE|AS3610_ECCURR_ITERM);
    as3610write(AS3610_NTC_SUPERVISION_REGISTER,AS3610_NTC_TEMP_50_OR_55_C|AS3610_NTC_100_K|AS3610_NTC_ON);
    as3610write(AS3610_CHARGER_SUPERVISION_REGISTER,STAT_MODE_4|CHARGING_TMAX_RESET|CH_TIMEOUT_5_00_H);
/*
    as3610write(AS3610_CHARGER_CONTROL_1_REGISTER,0xE7);
    as3610write(AS3610_CHARGER_VOLTAGE_CONTROL_REGISTER,0x0A);
    as3610write(AS3610_CHARGER_CURRENT_CONTROL_REGISTER,0x2C);
    as3610write(AS3610_NTC_SUPERVISION_REGISTER,0x01);
    as3610write(AS3610_CHARGER_SUPERVISION_REGISTER,0x8A);
 
 */

}

void init_as3610_standalone_100k_ntc()
{
    //AS3611-A stand alone version for 100kOhm NTC
    as3610write(AS3610_CHARGER_CONTROL_1_REGISTER,AS3610_NO_BAT_DET_DIS|AS3610_DISABLE_TOFF|AS3610_PRECHG_EN|USB_CURRENT_VALUE_STAND_ALONE|AS3610_BOOST_EN|AS3610_CHG_EN);
    as3610write(AS3610_CHARGER_VOLTAGE_CONTROL_REGISTER,AS3610_VCHG_MIN_LT_4_2_V|AS3610_VEOC_4_20_V);
    as3610write(AS3610_CHARGER_CURRENT_CONTROL_REGISTER,0x10|AS3610_BOOST_LOWCURR_500_MA|AS3610_CONSTCURR_1xICHARGE|AS3610_ECCURR_ITERM);
    as3610write(AS3610_NTC_SUPERVISION_REGISTER,AS3610_NTC_TEMP_45_OR_50_C|AS3610_NTC_100_K|AS3610_NTC_ON);
    as3610write(AS3610_CHARGER_SUPERVISION_REGISTER,STAT_MODE_4|CHARGING_TMAX_RESET|CH_TIMEOUT_5_00_H);
}

void init_as3610_standalone_10k_ntc()
{
    //AS3611-A stand alone version for 10kOhm NTC
    as3610write(AS3610_CHARGER_CONTROL_1_REGISTER,AS3610_NO_BAT_DET_DIS|AS3610_DISABLE_TOFF|AS3610_PRECHG_EN|USB_CURRENT_VALUE_STAND_ALONE|AS3610_BOOST_EN|AS3610_CHG_EN);
    as3610write(AS3610_CHARGER_VOLTAGE_CONTROL_REGISTER,AS3610_VCHG_MIN_LT_4_2_V|AS3610_VEOC_4_20_V);
    as3610write(AS3610_CHARGER_CURRENT_CONTROL_REGISTER,0x10|AS3610_BOOST_LOWCURR_500_MA|AS3610_CONSTCURR_1xICHARGE|AS3610_ECCURR_ITERM);
    as3610write(AS3610_NTC_SUPERVISION_REGISTER,AS3610_NTC_TEMP_45_OR_50_C|AS3610_NTC_10_K|AS3610_NTC_ON);
    as3610write(AS3610_CHARGER_SUPERVISION_REGISTER,STAT_MODE_4|CHARGING_TMAX_RESET|CH_TIMEOUT_5_00_H);
}